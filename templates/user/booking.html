{% extends "base.html" %}
{% block title %}Book Tickets - {{ movie.title }}{% endblock %}

{% block content %}
<div class="booking-page-container">
    <div class="selection-column">
        <div class="movie-details-booking">
            <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
            <div>
                <h2>{{ movie.title }}</h2>
                <p>{{ movie.plot }}</p>
            </div>
        </div>

        <div class="booking-steps">
            <div class="step">
                <h3>1. Select Date</h3>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prev-month-btn">&lt;</button>
                        <h4 id="month-year-display"></h4>
                        <button id="next-month-btn">&gt;</button>
                    </div>
                    <div class="calendar-body">
                        <div class="calendar-weekdays">
                            <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                        </div>
                        <div class="calendar-dates" id="calendar-dates"></div>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>2. Select Showtime</h3>
                <div id="showtimes-list">
                    <p class="placeholder-text">Please select a date.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="seating-column">
        <h3>3. Select Seats</h3>
        <div id="seating-area-wrapper">
            <p class="placeholder-text" id="seating-placeholder">Select a date & showtime.</p>
            <div class="seating-area" id="seating-area" style="display: none;">
                <div class="screen">SCREEN</div>
                <div class="seat-grid" id="seat-grid"></div>
                <div class="legend">
                    <div><div class="seat"></div>Available</div>
                    <div><div class="seat selected"></div>Selected</div>
                    <div><div class="seat occupied"></div>Occupied</div>
                </div>
            </div>
        </div>

        <div class="booking-summary" id="booking-summary" style="display: none;">
            <h4>Booking Summary</h4>
            <p><strong>Seats:</strong> <span id="selected-seats-display">None</span></p>
            <p><strong>Total:</strong> ₹<span id="total-price">0.00</span></p>
            <button id="proceed-to-pay-btn" class="action-btn" disabled>Confirm & Pay</button>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal-container" style="display:none;">
  <div class="modal-content payment-modal-content">
    <span class="close-btn" id="close-payment-modal">&times;</span>
    <h2>Confirm Booking</h2>
    <form id="payment-form">
      <input type="text" id="cardholder-name" placeholder="Cardholder Name" required>
      <input type="text" id="card-number" placeholder="Card Number" required>
      <input type="text" id="expiry-date" placeholder="Expiry (MM/YY)" required>
      <input type="text" id="cvv" placeholder="CVV" required>
      <button type="submit" class="action-btn">Pay ₹<span id="payment-amount">0.00</span></button>
    </form>
  </div>
</div>
{% endblock %}  {# <-- this closes block content #}

{% block scripts %}
  <script>const movieId = {{ movie.id }};</script>
  <script src="{{ url_for('static', filename='js/booking.js') }}"></script>

  <script>
    document.getElementById('payment-form').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent form submission

      const cardNumber = document.getElementById('card-number').value.trim();
      const expiryDate = document.getElementById('expiry-date').value.trim();
      const cvv = document.getElementById('cvv').value.trim();

      // Validation
      const cardRegex = /^\d{16}$/;
      const cvvRegex = /^\d{3}$/;
      const expiryRegex = /^(0[1-9]|1[0-2])\/\d{2}$/;

      let errors = [];

      if (!cardRegex.test(cardNumber)) {
        errors.push("Card number must be exactly 16 digits.");
      }

      if (!cvvRegex.test(cvv)) {
        errors.push("CVV must be exactly 3 digits.");
      }

      if (!expiryRegex.test(expiryDate)) {
        errors.push("Expiry date must be in MM/YY format.");
      } else {
        const [month, year] = expiryDate.split('/').map(Number);
        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear() % 100;

        if (year < currentYear || (year === currentYear && month < currentMonth)) {
          errors.push("Card has expired.");
        }
      }

      if (errors.length > 0) {
        alert("Payment Error:\n" + errors.join("\n"));
        return; // STOP: Do not proceed to payment or seat booking
      }

      // If all is good, submit the form to proceed with booking
      // Trigger booking.js booking logic here if needed or simply:
      document.getElementById('payment-form').submit();
    });
  </script>
{% endblock %}

